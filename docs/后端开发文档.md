# å›½é£è½»ç©åˆé›† - åç«¯å¼€å‘æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv1.0  
> æ›´æ–°æ—¶é—´ï¼š2026-02-12  
> é€‚ç”¨èŒƒå›´ï¼šNode.js åç«¯å¼€å‘

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
server/
â”œâ”€â”€ routes/           # è·¯ç”±ç›®å½•
â”‚   â”œâ”€â”€ wxLogin.js   # å¾®ä¿¡ç™»å½•
â”‚   â”œâ”€â”€ level.js     # å…³å¡ç®¡ç†
â”‚   â””â”€â”€ score.js     # åˆ†æ•°ç®¡ç†
â”œâ”€â”€ db/              # æ•°æ®åº“
â”‚   â””â”€â”€ db.js        # æ•°æ®åº“è¿æ¥
â”œâ”€â”€ utils/           # å·¥å…·å‡½æ•°
â”œâ”€â”€ app.js           # åº”ç”¨å…¥å£
â””â”€â”€ package.json     # ä¾èµ–é…ç½®
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. ç”¨æˆ·è¡¨ (users)

```sql
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  openid VARCHAR(100) UNIQUE NOT NULL,
  nickname VARCHAR(100),
  avatar_url VARCHAR(500),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**å­—æ®µè¯´æ˜ï¼š**
- `openid` - å¾®ä¿¡ç”¨æˆ·å”¯ä¸€æ ‡è¯†
- `nickname` - ç”¨æˆ·æ˜µç§°
- `avatar_url` - å¤´åƒURL
- `created_at` - åˆ›å»ºæ—¶é—´
- `updated_at` - æ›´æ–°æ—¶é—´

---

### 2. åˆ†æ•°è®°å½•è¡¨ (scores)

```sql
CREATE TABLE scores (
  id INT AUTO_INCREMENT PRIMARY KEY,
  openid VARCHAR(100) NOT NULL,
  game_id VARCHAR(50) NOT NULL,
  level INT NOT NULL,
  score INT NOT NULL,
  time_used DECIMAL(10,2),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_openid_game (openid, game_id),
  INDEX idx_game_level (game_id, level)
);
```

**å­—æ®µè¯´æ˜ï¼š**
- `openid` - ç”¨æˆ·æ ‡è¯†
- `game_id` - æ¸¸æˆç±»å‹ï¼ˆwordFind/charDiff/poetryConnectï¼‰
- `level` - å…³å¡æ•°
- `score` - å¾—åˆ†ï¼ˆæ»¡åˆ†100ï¼‰
- `time_used` - ç”¨æ—¶ï¼ˆç§’ï¼‰
- `created_at` - è®°å½•æ—¶é—´

---

### 3. æ¸¸æˆè¿›åº¦è¡¨ (game_progress)

```sql
CREATE TABLE game_progress (
  id INT AUTO_INCREMENT PRIMARY KEY,
  openid VARCHAR(100) NOT NULL,
  game_id VARCHAR(50) NOT NULL,
  max_level INT DEFAULT 1,
  total_stars INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_openid_game (openid, game_id)
);
```

**å­—æ®µè¯´æ˜ï¼š**
- `openid` - ç”¨æˆ·æ ‡è¯†
- `game_id` - æ¸¸æˆç±»å‹
- `max_level` - å·²è§£é”çš„æœ€é«˜å…³å¡
- `total_stars` - æ€»æ˜Ÿæ•°
- `updated_at` - æ›´æ–°æ—¶é—´

---

## ğŸ”Œ API æ¥å£

### 1. å¾®ä¿¡ç™»å½•

**æ¥å£ï¼š** `POST /api/wx/login`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "code": "å¾®ä¿¡ç™»å½•code"
}
```

**è¿”å›æ•°æ®ï¼š**
```json
{
  "success": true,
  "openid": "oXXXXXXXXXXXXXXXXXX",
  "session_key": "xxxxx"
}
```

**å®ç°ç¤ºä¾‹ï¼š**
```javascript
router.post('/login', async (req, res) => {
  const { code } = req.body;
  
  try {
    // è°ƒç”¨å¾®ä¿¡ API è·å– openid
    const wxRes = await axios.get(
      `https://api.weixin.qq.com/sns/jscode2session`,
      {
        params: {
          appid: process.env.WX_APPID,
          secret: process.env.WX_SECRET,
          js_code: code,
          grant_type: 'authorization_code'
        }
      }
    );
    
    const { openid, session_key } = wxRes.data;
    
    // ä¿å­˜æˆ–æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    await db.query(
      'INSERT INTO users (openid) VALUES (?) ON DUPLICATE KEY UPDATE openid=openid',
      [openid]
    );
    
    res.json({ success: true, openid, session_key });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

---

### 2. è·å–å…³å¡æ•°æ®

**æ¥å£ï¼š** `GET /api/level/data`

**è¯·æ±‚å‚æ•°ï¼š**
```
gameId: æ¸¸æˆIDï¼ˆwordFind/charDiff/poetryConnectï¼‰
difficulty: éš¾åº¦ï¼ˆeasy/normal/hardï¼‰
level: å…³å¡æ•°
openid: ç”¨æˆ·æ ‡è¯†
```

**è¿”å›æ•°æ®ï¼š**
```json
{
  "success": true,
  "levelData": {
    // æ ¹æ®æ¸¸æˆç±»å‹è¿”å›ä¸åŒæ•°æ®
  },
  "answer": "æ˜¥æš–èŠ±å¼€"
}
```

**æ‰¾æˆè¯­ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "levelData": {},
  "answer": "ä¸€å¸†é£é¡º"
}
```

**æ±‰å­—æ‰¾ä¸åŒç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "levelData": {
    "matrix": [
      ["å¤§", "å¤§", "å¤§"],
      ["å¤§", "å¤ª", "å¤§"],
      ["å¤§", "å¤§", "å¤§"]
    ],
    "diffAt": { "row": 1, "col": 1 },
    "base": "å¤§",
    "diff": "å¤ª"
  },
  "answer": ""
}
```

**è¯—è¯è¿çº¿ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "levelData": {
    "items": [
      { "id": "u1", "text": "åºŠå‰æ˜æœˆå…‰", "type": "upper" },
      { "id": "l1", "text": "ç–‘æ˜¯åœ°ä¸Šéœœ", "type": "lower" }
    ],
    "pairs": [["u1", "l1"]]
  },
  "answer": ""
}
```

**å®ç°ç¤ºä¾‹ï¼š**
```javascript
router.get('/data', async (req, res) => {
  const { gameId, difficulty, level, openid } = req.query;
  
  try {
    let levelData = {};
    let answer = '';
    
    if (gameId === 'wordFind') {
      // ä»é¢˜åº“éšæœºé€‰ä¸€ä¸ªæˆè¯­
      answer = getRandomIdiom(difficulty);
      
    } else if (gameId === 'charDiff') {
      // ç”Ÿæˆæ±‰å­—æ‰¾ä¸åŒæ•°æ®
      const data = generateCharDiffLevel(difficulty);
      levelData = data;
      
    } else if (gameId === 'poetryConnect') {
      // ç”Ÿæˆè¯—è¯è¿çº¿æ•°æ®
      levelData = generatePoetryLevel(difficulty);
    }
    
    res.json({ success: true, levelData, answer });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

---

### 3. ä¸Šä¼ åˆ†æ•°

**æ¥å£ï¼š** `POST /api/score/upload`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "openid": "oXXXXXXXXXXXXXXXXXX",
  "gameId": "wordFind",
  "level": 1,
  "score": 95,
  "timeUsed": 12.5
}
```

**è¿”å›æ•°æ®ï¼š**
```json
{
  "success": true,
  "message": "åˆ†æ•°å·²ä¿å­˜"
}
```

**å®ç°ç¤ºä¾‹ï¼š**
```javascript
router.post('/upload', async (req, res) => {
  const { openid, gameId, level, score, timeUsed } = req.body;
  
  try {
    // ä¿å­˜åˆ†æ•°è®°å½•
    await db.query(
      'INSERT INTO scores (openid, game_id, level, score, time_used) VALUES (?, ?, ?, ?, ?)',
      [openid, gameId, level, score, timeUsed]
    );
    
    // æ›´æ–°æ¸¸æˆè¿›åº¦
    await db.query(
      `INSERT INTO game_progress (openid, game_id, max_level, total_stars) 
       VALUES (?, ?, ?, ?) 
       ON DUPLICATE KEY UPDATE 
         max_level = GREATEST(max_level, ?),
         total_stars = total_stars + ?`,
      [openid, gameId, level + 1, getStars(score), level + 1, getStars(score)]
    );
    
    res.json({ success: true, message: 'åˆ†æ•°å·²ä¿å­˜' });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

---

### 4. è·å–æ’è¡Œæ¦œ

**æ¥å£ï¼š** `GET /api/score/rank`

**è¯·æ±‚å‚æ•°ï¼š**
```
gameId: æ¸¸æˆID
level: å…³å¡æ•°ï¼ˆå¯é€‰ï¼Œä¸ä¼ åˆ™ä¸ºæ€»æ’è¡Œï¼‰
limit: è¿”å›æ•°é‡ï¼ˆé»˜è®¤100ï¼‰
```

**è¿”å›æ•°æ®ï¼š**
```json
{
  "success": true,
  "rank": [
    {
      "openid": "oXXXXXXXXXXXXXXXXXX",
      "nickname": "ç©å®¶1",
      "avatar_url": "https://...",
      "score": 100,
      "time_used": 10.5,
      "rank": 1
    }
  ]
}
```

**å®ç°ç¤ºä¾‹ï¼š**
```javascript
router.get('/rank', async (req, res) => {
  const { gameId, level, limit = 100 } = req.query;
  
  try {
    let sql = `
      SELECT 
        s.openid,
        u.nickname,
        u.avatar_url,
        s.score,
        s.time_used,
        ROW_NUMBER() OVER (ORDER BY s.score DESC, s.time_used ASC) as rank
      FROM scores s
      LEFT JOIN users u ON s.openid = u.openid
      WHERE s.game_id = ?
    `;
    
    const params = [gameId];
    
    if (level) {
      sql += ' AND s.level = ?';
      params.push(level);
    }
    
    sql += ' ORDER BY s.score DESC, s.time_used ASC LIMIT ?';
    params.push(parseInt(limit));
    
    const [rows] = await db.query(sql, params);
    
    res.json({ success: true, rank: rows });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

---

### 5. è·å–ç”¨æˆ·è¿›åº¦

**æ¥å£ï¼š** `GET /api/progress/get`

**è¯·æ±‚å‚æ•°ï¼š**
```
openid: ç”¨æˆ·æ ‡è¯†
```

**è¿”å›æ•°æ®ï¼š**
```json
{
  "success": true,
  "progress": {
    "wordFind": { "max_level": 5, "total_stars": 12 },
    "charDiff": { "max_level": 3, "total_stars": 7 },
    "poetryConnect": { "max_level": 2, "total_stars": 5 }
  }
}
```

**å®ç°ç¤ºä¾‹ï¼š**
```javascript
router.get('/get', async (req, res) => {
  const { openid } = req.query;
  
  try {
    const [rows] = await db.query(
      'SELECT game_id, max_level, total_stars FROM game_progress WHERE openid = ?',
      [openid]
    );
    
    const progress = {};
    rows.forEach(row => {
      progress[row.game_id] = {
        max_level: row.max_level,
        total_stars: row.total_stars
      };
    });
    
    res.json({ success: true, progress });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

---

## ğŸ² å…³å¡æ•°æ®ç”Ÿæˆ

### æ‰¾æˆè¯­é¢˜åº“

**ç®€å•éš¾åº¦æˆè¯­ç¤ºä¾‹ï¼š**
```javascript
const EASY_IDIOMS = [
  'ä¸€å¸†é£é¡º', 'æ˜¥æš–èŠ±å¼€', 'é©¬åˆ°æˆåŠŸ',
  'å¿ƒæƒ³äº‹æˆ', 'å‰ç¥¥å¦‚æ„', 'é¾™é©¬ç²¾ç¥'
];
```

**ä¸€èˆ¬éš¾åº¦æˆè¯­ç¤ºä¾‹ï¼š**
```javascript
const NORMAL_IDIOMS = [
  'ä¿¡å±±ç¦æ»¡', 'æ‰é«˜å…«æ–—', 'å­¦å¯Œäº”è½¦',
  'ç´æ£‹ä¹¦ç”»', 'é£èŠ±é›ªæœˆ', 'è¯—æƒ…ç”»æ„'
];
```

**å›°éš¾éš¾åº¦æˆè¯­ç¤ºä¾‹ï¼š**
```javascript
const HARD_IDIOMS = [
  'é¹ç¨‹ä¸‡é‡Œ', 'é”¦ç»£å‰ç¨‹', 'å¦‚è™æ·»ç¿¼',
  'å‡ºç±»æ‹”èƒ', 'å“å°”ä¸ç¾¤', 'ä¸¾ä¸–æ— åŒ'
];
```

---

### æ±‰å­—æ‰¾ä¸åŒç”Ÿæˆç®—æ³•

```javascript
function generateCharDiffLevel(difficulty) {
  // æ ¹æ®éš¾åº¦é€‰æ‹©å­—å½¢ç›¸ä¼¼çš„å­—å¯¹
  const pairs = {
    easy: [
      { base: 'æœ¨', diff: 'æœª' },
      { base: 'åœŸ', diff: 'å£«' },
      { base: 'æ—¥', diff: 'ç›®' }
    ],
    normal: [
      { base: 'å·±', diff: 'å·²' },
      { base: 'åˆ', diff: 'ç‰›' },
      { base: 'åƒ', diff: 'å¹²' }
    ],
    hard: [
      { base: 'æˆŒ', diff: 'æˆ' },
      { base: 'è¾¨', diff: 'è¾©' },
      { base: 'è´¦', diff: 'å¸' }
    ]
  };
  
  const pair = pairs[difficulty][Math.floor(Math.random() * pairs[difficulty].length)];
  const config = DIFFICULTY_CONFIG[difficulty];
  
  // éšæœºæ”¾ç½®ä¸åŒçš„å­—
  const diffRow = Math.floor(Math.random() * config.rows);
  const diffCol = Math.floor(Math.random() * config.cols);
  
  // ç”ŸæˆçŸ©é˜µ
  const matrix = [];
  for (let r = 0; r < config.rows; r++) {
    const row = [];
    for (let c = 0; c < config.cols; c++) {
      row.push(r === diffRow && c === diffCol ? pair.diff : pair.base);
    }
    matrix.push(row);
  }
  
  return {
    matrix,
    diffAt: { row: diffRow, col: diffCol },
    base: pair.base,
    diff: pair.diff
  };
}
```

---

### è¯—è¯è¿çº¿ç”Ÿæˆç®—æ³•

```javascript
function generatePoetryLevel(difficulty) {
  const poetryBank = {
    easy: [
      { upper: 'åºŠå‰æ˜æœˆå…‰', lower: 'ç–‘æ˜¯åœ°ä¸Šéœœ' },
      { upper: 'æ˜¥çœ ä¸è§‰æ™“', lower: 'å¤„å¤„é—»å•¼é¸Ÿ' },
      { upper: 'ç™½æ—¥ä¾å±±å°½', lower: 'é»„æ²³å…¥æµ·æµ' }
    ],
    normal: [
      // 5å¯¹è¯—å¥
    ],
    hard: [
      // 8å¯¹è¯—å¥
    ]
  };
  
  const count = { easy: 3, normal: 5, hard: 8 }[difficulty];
  const selected = shuffleArray(poetryBank[difficulty]).slice(0, count);
  
  const items = [];
  const pairs = [];
  
  selected.forEach((poem, i) => {
    const uId = `u${i + 1}`;
    const lId = `l${i + 1}`;
    
    items.push({ id: uId, text: poem.upper, type: 'upper' });
    items.push({ id: lId, text: poem.lower, type: 'lower' });
    
    pairs.push([uId, lId]);
  });
  
  // æ‰“ä¹±ä¸‹åŠéƒ¨åˆ†é¡ºåº
  const lowerItems = items.filter(item => item.type === 'lower');
  shuffleArray(lowerItems);
  
  return { items, pairs };
}
```

---

## ğŸ” å®‰å…¨è§„èŒƒ

### 1. å‚æ•°æ ¡éªŒ

```javascript
// ä½¿ç”¨ express-validator
const { body, validationResult } = require('express-validator');

router.post('/upload',
  [
    body('openid').notEmpty().isString(),
    body('gameId').isIn(['wordFind', 'charDiff', 'poetryConnect']),
    body('level').isInt({ min: 1 }),
    body('score').isInt({ min: 0, max: 100 }),
  ],
  async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    // å¤„ç†è¯·æ±‚
  }
);
```

### 2. SQL æ³¨å…¥é˜²æŠ¤

```javascript
// âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
await db.query('SELECT * FROM users WHERE openid = ?', [openid]);

// âŒ ç¦æ­¢å­—ç¬¦ä¸²æ‹¼æ¥
// await db.query(`SELECT * FROM users WHERE openid = '${openid}'`);
```

### 3. æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

```javascript
// ä½¿ç”¨ç¯å¢ƒå˜é‡
require('dotenv').config();

const config = {
  wxAppId: process.env.WX_APPID,
  wxSecret: process.env.WX_SECRET,
  dbHost: process.env.DB_HOST,
  dbPassword: process.env.DB_PASSWORD
};
```

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. ç¯å¢ƒè¦æ±‚

- Node.js >= 14.0
- MySQL >= 5.7
- PM2ï¼ˆè¿›ç¨‹ç®¡ç†ï¼‰

### 2. æ•°æ®åº“åˆå§‹åŒ–

```bash
# åˆ›å»ºæ•°æ®åº“
mysql -u root -p
CREATE DATABASE vx_game CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# å¯¼å…¥è¡¨ç»“æ„
mysql -u root -p vx_game < schema.sql
```

### 3. å®‰è£…ä¾èµ–

```bash
cd server
npm install
```

### 4. é…ç½®ç¯å¢ƒå˜é‡

```bash
# .env
WX_APPID=your_appid
WX_SECRET=your_secret
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=vx_game
PORT=3000
```

### 5. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘ç¯å¢ƒ
npm run dev

# ç”Ÿäº§ç¯å¢ƒ
pm2 start app.js --name vx-game-api
```

---

## ğŸ”§ å¼‚å¸¸å¤„ç†

### å…¨å±€é”™è¯¯å¤„ç†

```javascript
// app.js
app.use((err, req, res, next) => {
  console.error('[Error]', err);
  
  // è®°å½•é”™è¯¯æ—¥å¿—
  logger.error({
    message: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
    body: req.body
  });
  
  // è¿”å›é”™è¯¯å“åº”
  res.status(500).json({
    success: false,
    error: process.env.NODE_ENV === 'production' 
      ? 'æœåŠ¡å™¨é”™è¯¯' 
      : err.message
  });
});
```

---

## ğŸ“ æ—¥å¿—è§„èŒƒ

### ä½¿ç”¨ Winston

```javascript
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

// è®°å½•è¯·æ±‚æ—¥å¿—
app.use((req, res, next) => {
  logger.info({
    method: req.method,
    url: req.url,
    ip: req.ip,
    timestamp: new Date().toISOString()
  });
  next();
});
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å‰ç«¯å¼€å‘æ–‡æ¡£](./å‰ç«¯å¼€å‘æ–‡æ¡£.md)
- [äº§å“éœ€æ±‚æ–‡æ¡£](./äº§å“éœ€æ±‚æ–‡æ¡£.md)
- [ç§¯åˆ†è§„åˆ™æ–‡æ¡£](./ç§¯åˆ†è§„åˆ™æ–‡æ¡£.md)
